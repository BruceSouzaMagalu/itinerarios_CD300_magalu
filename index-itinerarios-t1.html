<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Itinerários Magalu CD300</title>
    <link rel="icon" href="images/busicon.png">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
</head>
<body>

    <header>
        <a href="index.html" class="back-arrow" aria-label="Voltar para a página inicial">
            <img src="images/back-button.png" alt="Voltar" class="back-arrow-img">
        </a>
        <a href="index.html"><h1>Itinerários Magalu CD300 - 1º Turno</h1></a>
        
    </header>
    <div class="gradiente"></div>

    <p>Escolha um itinerário abaixo para visualizar</p>

    <div class="containeritinerarios"></div>

        <div id="overlay" class="overlay">
        <header class="overlay-header">
            <a href="#" class="close-overlay" aria-label="Fechar">
                <img src="images/back-button.png" alt="Voltar" class="back-arrow-img">
            </a>
            <h1 id="overlay-title">Detalhes do Itinerário</h1>
        </header>
        <div class="overlay-content">
            <table class="itinerary-table">
                <thead>
                    <tr>
                        <th>Endereço</th>
                        <th>Ponto de Referência</th>
                        <th>Horário</th>
                    </tr>
                </thead>
                <tbody id="itinerary-data">
                    <!-- Os dados serão preenchidos dinamicamente -->
                </tbody>
            </table>
        </div>
    </div>
    
    <script>
        let itineraries = {};
    
        // Função para carregar o arquivo CSV
        function loadCSV() {
        const container = document.querySelector('.containeritinerarios');
        container.innerHTML = '';
        Papa.parse("itinerarios.csv?v=" + Date.now(), {
            download: true,
            header: true,
            skipEmptyLines: true,
            encoding: "UTF-8",
            transformHeader: function(h){ return (h || '').trim().toLowerCase(); },
            transform: function(v){ return typeof v === 'string' ? v.trim() : v; },
            complete: function (results) {
                processCSVData(results.data);
            },
            error: function (error) {
                console.error("Erro ao carregar o arquivo CSV:", error);
            }
        });
}

    function fixEncoding(str) {
        if (typeof str !== 'string') return '';
        const cleaned = str.replace(/\uFFFD/g, '');
        return cleaned.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }

    function processCSVData(data) {
        data.forEach(row => {
            const itinerario = fixEncoding(row.itinerario);
            const endereco = fixEncoding(row.endereco);
            const referencia = fixEncoding(row.referencia);
            const horario = row.horario;
            const turno = (row.turno || '').toUpperCase();

            if (turno === 'T1' && itinerario) {
                if (!itineraries[itinerario]) {
                    itineraries[itinerario] = [];
                }
                itineraries[itinerario].push({ endereco, referencia, horario });
            }
        });
        renderItineraryList();
    }
    
        function renderItineraryList() {
            const container = document.querySelector('.containeritinerarios');
            const itineraryNames = Object.keys(itineraries).sort();
            if (itineraryNames.length === 0) {
                container.innerHTML = '<p class="empty-message">Nenhum itinerário disponível para este turno.</p>';
                return;
            }
            container.innerHTML = itineraryNames
                .map(name => `<a class=\"containerturnos-item\">${name}</a>`) 
                .join('');
        }
    
        // Exibe a tela sobreposta com os dados do itinerário (delegação de evento)
        document.querySelector('.containeritinerarios').addEventListener('click', function (e) {
            const target = e.target.closest('.containerturnos-item');
            if (!target) return;
            const locationName = target.textContent.trim();
            const overlay = document.getElementById('overlay');
            const overlayTitle = document.getElementById('overlay-title');
            const itineraryData = document.getElementById('itinerary-data');

            overlayTitle.textContent = `Itinerário: ${locationName}`;
            if (itineraries[locationName]) {
                itineraryData.innerHTML = itineraries[locationName]
                    .map(row => `
                        <tr>
                            <td>${row.endereco}</td>
                            <td>${row.referencia}</td>
                            <td>${row.horario}</td>
                        </tr>
                    `).join('');
            } else {
                itineraryData.innerHTML = `<tr><td colspan="3">Nenhum dado encontrado.</td></tr>`;
            }

            overlay.style.display = 'block';
        });
    
        // Fecha a tela sobreposta
        document.querySelector('.close-overlay').addEventListener('click', function (e) {
            e.preventDefault();
            document.getElementById('overlay').style.display = 'none';
        });
    
        // Carrega o CSV ao iniciar
        loadCSV();
    </script>

</body>
</html>